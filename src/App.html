<!--
	Web App to simulate
	---------------------
	Conway's Game of Life
	(see https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life)
	---------------------
	by jean-claude@schmidig.email
-->
<section class="section container">
  <h1 class="title">
    <a
      href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life"
      target="_blank"
      >Conways's Game of Life</a
    >
  </h1>
</section>
<Start
  {markOffset}
  {defDimension}
  {dimMin}
  {dimMax}
  on:clear="{clear}"
  on:create="{create}"
/>
<Game {status} {calc} showTitle="{show.title}" {showDiff} on:click="{next}" />
<Board
  {fields}
  {screenWidth}
  {cellWidth}
  on:flip="{flip}"
  on:measure="{measureRun}"
  on:unmeasure="{measureStop}"
/>

<script>
  import Start from "./Start.html"
  import Game from "./Game.html"
  import Board, { createBoard } from "./Board.html"
  import { createMeasure } from "./common/Measure.html"
  //
  const [defDimension, dimMin, dimMax] = [15, 3, Math.floor(Math.sqrt(1e6))],
    markOffset = "idOffset",
    calc = createMeasure("Calc"),
    show = createMeasure("Display")

  /*** Observables ***/
  let board, fields, length, status, showDiff, cellWidth, screenWidth
  $: if (board) {
    fields = board.fields
    length = Math.sqrt(board.size)
    cellWidth = Math.floor(
      document.getElementById(markOffset).offsetWidth / length
    )
    screenWidth = cellWidth * length
    status = {
      size: board.size,
      generation: board.generation(),
      countState: board.countState,
      countChangedState: board.countChangedState
    }
  }

  /*** events ***/
  const evt = (action, newBoard = false) => (
      event,
      prop = event.detail,
      dim = prop
    ) => (board = (newBoard && createBoard(dim, calc)) || board)[action](prop),
    //
    // Propagated by component Start
    clear = evt("clear", true),
    create = evt("create", true),
    // Propagated by component Game
    next = evt("next"),
    // Propagated by component Board
    flip = evt("flip"),
    measureRun = () => show.start(),
    measureStop = () => (showDiff = show.stop())
</script>
