<!--
	Web App to simulate
	---------------------
	Conway's Game of Life
	(see https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life)
	---------------------
	by jean-claude@schmidig.email
-->
<section class="section">
  <div class="container">
    <h1 class="title">
      <a
        href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life"
        target="_blank"
        >Conways's Game of Life</a
      >
    </h1>
  </div>
</section>
<Start
  {defDimension}
  {dimMin}
  {dimMax}
  on:clear="{clear}"
  on:create="{create}"
/>
<Game {status} {calc} showTitle="{show.title}" {showDiff} on:click="{next}" />
<Board
  {rows} {cellWidth}
  on:flip="{flip}"
  on:measure="{measureRun}"
  on:unmeasure="{measureStop}"
/>

<script>
  import Start from "./Start.html"
  import Game from "./Game.html"
  import Board, { createBoard } from "./Board.html"
  import { createMeasure } from "./common/Measure.html"
  import { checkMinMax } from "./common/Util.html"
  //
  const [defDimension, dimMin, dimMax] = [15, 3, Math.floor(Math.sqrt(1e5))],
    calc = createMeasure("Calc"),
    show = createMeasure("Display")

  /*** Observables ***/
  let board,
    rows = [],
    status,
    showDiff,
	cellWidth
  $: if (board) {
    rows = board.rows
    status = {
      size: board.size,
      generation: board.generation(),
      isReady: board.isReady(),
      countState: board.countState,
      countChangedState: board.countChangedState
    }
  }
  $: if (rows.length) {
  	cellWidth = Math.max(document.documentElement.clientWidth,
  					  window.innerWidth || 0)
  	cellWidth = Math.floor(checkMinMax((cellWidth-64)/rows.length/2,
		1, cellWidth/24))
  }

  /*** events ***/
  const evt = (action, newBoard = false) => (
      event,
      prop = event.detail,
      dim = prop
    ) => (board = (newBoard && createBoard(dim, calc)) || board)[action](prop),
    //
    // Issued by component Start
    clear = evt("clear", true),
    create = evt("create", true),
    // Issued by component Game
    next = evt("next"),
    // Issued by component Field
    flip = evt("flip"),
    // Issued by component Board
    measureRun = () => show.start(),
    measureStop = () => (showDiff = show.stop())
</script>
