<section class="container box">
  <table class="table is-bordered is-fullwidth">
    {#each rows as row}
    <tr>
      {#each row as field}
      <Field
        row="{field.row}"
        col="{field.col}"
        state="{field.state()}"
        {cellWidth}
        on:flip
      />
      {/each}
    </tr>
    {:else}
    <Explanation />
    {/each}
  </table>
</section>

<script>
  import { createEventDispatcher, beforeUpdate, afterUpdate } from "svelte"
  import Field from "./Field.html"
  import Explanation from "./Explanation.html"

  /*** Default Component Interface ***/
  export let rows, cellWidth

  /*** events ***/
  const dispatch = createEventDispatcher()
  beforeUpdate(() => dispatch("measure"))
  afterUpdate(() => dispatch("unmeasure"))
</script>

<script context="module">
  import {
    propCounter,
    objCounter,
    filler,
    pusher,
    mapper,
    fillArray,
    call,
    checkBorder
  } from "./common/Util.html"
  import { createField } from "./Field.html"

  export const createBoard = (_dimension = 0, _measure = null) => {
    let generation
    //
    const size = _dimension ** 2,
      _fields = fillArray(size, createField, _dimension),
      //
      rows = filler(_fields)((acc, field) =>
        field.col ? acc[acc.length - 1].push(field) : acc.push([field])
      ),
      _getField = index => rows[index.row][index.col],
      //
      _doMeasure = (action, ...arg) =>
        void (_measure && _measure.start(),
        (generation = action(...arg)),
        _measure && _measure.stop()),
      //
      _flip = index => (_getField(index).flip(), +generation),
      //
      _fill = action => (action ? (_fields.map(call(action)), 0) : ""),
      //
      _next = () => (
        mapper(_fields)("setState", _getNextStates()), generation + 1
      ),
      //
      _getNextStates = () =>
        pusher(_fields)(field =>
          field.nextState(
            propCounter(Neighborhood)(_checkAlive, field.row, field.col)
          )
        ),
      //
      _checkAlive = (o, row, col) =>
        _checkBorder((row += o[0])) &&
        _checkBorder((col += o[1])) &&
        _getField({ row, col }).state(),
      //
      _checkBorder = value => checkBorder(value, _dimension),
      //
      _fieldCount = (prop, state) => objCounter(_fields)(prop, state),
      //
      /*** Neighborhood ***/
      _base = [-1, 0, 1],
      Neighborhood = Array.from(_base, x =>
        Array.from(_base, y => [x, y])
      ).flat()
    //
    /*** Component Interface ***/
    return {
      //
      // static getters
      size,
      rows,
      //
      // dynamic getters
      generation: () => generation,
      isReady: () => generation === 0,
      countState: state => _fieldCount("hasState", state),
      countChangedState: state => _fieldCount("hasChangedState", state),
      //
      // setters
      clear: () => _doMeasure(_fill),
      create: () => _doMeasure(_fill, "setRandom"),
      next: () => _doMeasure(_next),
      flip: index => _doMeasure(_flip, index)
    }
  }
</script>
