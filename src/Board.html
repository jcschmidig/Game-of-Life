<section class="container box">
  {#if fields}
  <svg style="width: {screenWidth}px; height: {screenWidth}px;">
    {#each fields as {pos, row, col, state}}
    <Field {pos} {row} {col} state="{state()}" {cellWidth} on:flip />
    {/each}
  </svg>
  {:else}
  <Explanation />
  {/if}
</section>

<style>
  section {
    padding-left: 0;
    padding-right: 0;
  }
  svg {
    display: block;
    margin: auto;
  }
</style>

<script>
  import { createEventDispatcher, beforeUpdate, afterUpdate } from "svelte"
  import Field from "./Field.html"
  import Explanation from "./Explanation.html"

  /*** Default Component Interface ***/
  export let fields, screenWidth, cellWidth

  /*** events ***/
  const dispatch = createEventDispatcher()
  beforeUpdate(() => dispatch("measure"))
  afterUpdate(() => dispatch("unmeasure"))
</script>

<script context="module">
  import {
    propCounter,
    objCounter,
    filler,
    pusher,
    mapper,
    fillArray,
    call,
    checkBorder
  } from "./common/Util.html"
  import { createField } from "./Field.html"

  export const createBoard = (dimension = 0, measure = null) => {
    let generation = 0
    //
    const size = dimension ** 2,
      fields = fillArray(size, createField, dimension),
      _rows = filler(fields)((acc, field) =>
        field.col ? acc[acc.length - 1].push(field) : acc.push([field])
      ),
      //
      _doMeasure = (action, ...arg) =>
        void (measure && measure.start(),
        (generation = action(...arg)),
        measure && measure.stop()),
      //
      _flip = index => (fields[index].flip(), generation),
      //
      _fill = action => (fields.map(call(action)), 0),
      //
      _next = () => (
        mapper(fields)("setState", _getNextStates()), generation + 1
      ),
      //
      _getNextStates = () =>
        pusher(fields)(field =>
          field.nextState(
            propCounter(Neighborhood)(_checkAlive, field.row, field.col)
          )
        ),
      //
      _checkAlive = (ngb, row, col, r=row+ngb[0], c=col+ngb[1]) =>
        _checkBorder(r) &&
        _checkBorder(c) &&
        _rows[r][c].state(),
      //
      _checkBorder = value => checkBorder(value, dimension),
      //
      _fieldCount = (prop, state) => objCounter(fields)(prop, state),
      //
      /*** Neighborhood ***/
      _base = [-1, 0, 1],
      Neighborhood = Array.from(_base, x =>
        Array.from(_base, y => [x, y])
      ).flat()
    //
    /*** Component Interface ***/
    return {
      //
      // static getters
      size,
      fields,
      //
      // dynamic getters
      generation: () => generation,
      countState: state => _fieldCount("hasState", state),
      countChangedState: state => _fieldCount("hasChangedState", state),
      //
      // setters
      clear: () => _doMeasure(_fill),
      create: () => _doMeasure(_fill, "setRandom"),
      next: () => _doMeasure(_next),
      flip: index => _doMeasure(_flip, index)
    }
  }
</script>
